{{- if .Page.Scratch.Get "needs_iresizer" -}}
  <script src="https://cdn.jsdelivr.net/npm/iframe-resizer/js/iframeResizer.min.js" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const frames = document.querySelectorAll('iframe[data-iresize="true"]');
      if (!frames.length || typeof iFrameResize !== "function") return;

      const defaults = {
        license: "GPLv3",
        checkOrigin: false,
        // waitForLoad: true, // uncomment if your applets draw after load
        // log: true,        // temporary debugging
        onResized: function ({ iframe, height }) {
          const wrapper = iframe?.parentElement;
          if (!wrapper) return;

          // read the scale from the data attribute
          const scaleStr = iframe.getAttribute("data-transform-scale") || "1";
          let scale = parseFloat(scaleStr);
          if (!Number.isFinite(scale) || scale <= 0) scale = 1;

          // height is the *unscaled* content height
          // set wrapper height to the visible (scaled) height
          wrapper.style.height = (height * scale) + "px";
        },
      };

      frames.forEach((el) => {
        const opts = { ...defaults };

        const co = el.getAttribute("data-check-origin");
        if (co === "true")  opts.checkOrigin = true;
        if (co === "false") opts.checkOrigin = false;

        if (el.getAttribute("data-log") === "true") opts.log = true;

        // Apply the transform scale directly to the iframe
        const scale = el.getAttribute("data-transform-scale") || "1";
        el.style.transform = `scale(${scale})`;

        if (!el.iFrameResizer) iframeResize(opts, el);
      });
    });
  </script>
{{- end -}}

{{- if or (.Page.Scratch.Get "needs_pyodide") (.Page.Scratch.Get "needs_sql") -}}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
{{- end -}}

{{- if .Page.Scratch.Get "needs_pyodide" -}}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/python/python.min.js"></script>
  <script>
    // ── CodeMirror editor initialization ──
    const _pyodideEditors = {};

    document.querySelectorAll('.pyodide-block').forEach(block => {
      const textarea = block.querySelector('textarea');
      if (!textarea) return;

      const id = block.id;
      const original = textarea.value;

      const cm = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: 'material-darker',
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineNumbers: false,
        viewportMargin: Infinity,
      });

      cm._originalCode = original;
      _pyodideEditors[id] = cm;
    });

    // ── Pyodide runtime (lazy-loaded on first run) ──
    let _pyodideReady = null;

    async function _getPyodide() {
      if (!_pyodideReady) {
        _pyodideReady = (async () => {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/pyodide/v0.27.2/full/pyodide.js';
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
          return await loadPyodide();
        })();
      }
      return _pyodideReady;
    }

    async function pyodideRun(id) {
      const cm = _pyodideEditors[id];
      const outEl = document.getElementById(id + '-output');
      const runBtn = document.getElementById(id + '-run');
      const statusEl = document.getElementById(id + '-status');
      const code = cm.getValue();

      runBtn.disabled = true;
      outEl.textContent = '';
      outEl.classList.remove('pyodide-output-hidden');
      statusEl.textContent = 'Chargement de Pyodide…';

      try {
        const pyodide = await _getPyodide();
        statusEl.textContent = 'Exécution…';

        pyodide.runPython(`
import sys, io
sys.stdout = io.StringIO()
sys.stderr = io.StringIO()
`);
        try {
          pyodide.runPython(code);
        } catch (pyErr) {
          const stderr = pyodide.runPython('sys.stderr.getvalue()');
          const stdout = pyodide.runPython('sys.stdout.getvalue()');
          outEl.innerHTML = '';
          if (stdout) {
            outEl.appendChild(document.createTextNode(stdout));
          }
          const errSpan = document.createElement('span');
          errSpan.className = 'pyodide-error';
          errSpan.textContent = stderr || pyErr.message;
          outEl.appendChild(errSpan);
          return;
        } finally {
          const stdout = pyodide.runPython('sys.stdout.getvalue()');
          const stderr = pyodide.runPython('sys.stderr.getvalue()');
          pyodide.runPython(`
sys.stdout = sys.__stdout__
sys.stderr = sys.__stderr__
`);
          if (!outEl.children.length) {
            outEl.textContent = stdout;
            if (stderr) {
              const errSpan = document.createElement('span');
              errSpan.className = 'pyodide-error';
              errSpan.textContent = stderr;
              outEl.appendChild(errSpan);
            }
          }
        }
        statusEl.textContent = '';
      } catch (err) {
        outEl.innerHTML = '';
        const errSpan = document.createElement('span');
        errSpan.className = 'pyodide-error';
        errSpan.textContent = err.message;
        outEl.appendChild(errSpan);
        statusEl.textContent = '';
      } finally {
        runBtn.disabled = false;
      }
    }

    function pyodideReset(id) {
      const cm = _pyodideEditors[id];
      cm.setValue(cm._originalCode);
      const outEl = document.getElementById(id + '-output');
      outEl.textContent = '';
    }
  </script>
{{- end -}}

{{- if .Page.Scratch.Get "needs_sql" -}}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/sql/sql.min.js"></script>
  <script>
    // ── CodeMirror editor initialization for SQL blocks ──
    const _sqlEditors = {};

    document.querySelectorAll('.sql-block').forEach(block => {
      const textarea = block.querySelector('textarea');
      if (!textarea) return;

      const id = block.id;
      const original = textarea.value;

      const cm = CodeMirror.fromTextArea(textarea, {
        mode: 'text/x-sql',
        theme: 'material-darker',
        indentUnit: 2,
        tabSize: 2,
        indentWithTabs: false,
        lineNumbers: false,
        viewportMargin: Infinity,
      });

      cm._originalCode = original;
      _sqlEditors[id] = cm;
    });

    // ── sql.js runtime (lazy-loaded on first run) ──
    let _sqlDbReady = null;

    async function _getSqlDb() {
      if (!_sqlDbReady) {
        _sqlDbReady = (async () => {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/sql.js@1/dist/sql-wasm.js';
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
          const SQL = await initSqlJs({
            locateFile: () => 'https://cdn.jsdelivr.net/npm/sql.js@1/dist/sql-wasm.wasm'
          });
          return new SQL.Database();
        })();
      }
      return _sqlDbReady;
    }

    function _sqlResultToTable(columns, values) {
      let html = '<table><thead><tr>';
      for (const col of columns) {
        html += '<th>' + _sqlEscape(col) + '</th>';
      }
      html += '</tr></thead><tbody>';
      for (const row of values) {
        html += '<tr>';
        for (const val of row) {
          if (val === null) {
            html += '<td class="sql-null">NULL</td>';
          } else {
            html += '<td>' + _sqlEscape(String(val)) + '</td>';
          }
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      return html;
    }

    function _sqlEscape(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    async function sqlRun(id) {
      const cm = _sqlEditors[id];
      const outEl = document.getElementById(id + '-output');
      const runBtn = document.getElementById(id + '-run');
      const statusEl = document.getElementById(id + '-status');
      const code = cm.getValue();

      runBtn.disabled = true;
      outEl.innerHTML = '';
      outEl.classList.remove('sql-output-hidden');
      statusEl.textContent = 'Chargement de SQL.js…';

      try {
        const db = await _getSqlDb();
        statusEl.textContent = 'Exécution…';

        const results = db.exec(code);

        if (results.length === 0) {
          // Statement with no results (CREATE, INSERT, UPDATE, DELETE…)
          const changes = db.getRowsModified();
          const msg = document.createElement('div');
          msg.className = 'sql-message';
          msg.textContent = changes > 0
            ? changes + ' ligne(s) modifiée(s).'
            : 'Requête exécutée avec succès.';
          outEl.appendChild(msg);
        } else {
          // One or more result sets
          for (const res of results) {
            const div = document.createElement('div');
            div.innerHTML = _sqlResultToTable(res.columns, res.values);
            outEl.appendChild(div);
          }
        }
        statusEl.textContent = '';
      } catch (err) {
        outEl.innerHTML = '';
        const msg = document.createElement('div');
        msg.className = 'sql-message sql-error';
        msg.textContent = err.message;
        outEl.appendChild(msg);
        statusEl.textContent = '';
      } finally {
        runBtn.disabled = false;
      }
    }

    function sqlReset(id) {
      const cm = _sqlEditors[id];
      cm.setValue(cm._originalCode);
      const outEl = document.getElementById(id + '-output');
      outEl.innerHTML = '';
      outEl.classList.add('sql-output-hidden');
    }
  </script>
{{- end -}}